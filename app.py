from flask import Flask, render_template, request, jsonify
import google.generativeai as genai
from google.generativeai.types import HarmCategory, HarmBlockThreshold

app = Flask(__name__)

# API Configuration
# GEMINI_API_KEY = "AIzaSyBdC4BJnV7NMn5tQzsx3r3ZgUJMsJPWH5k"
import os
GEMINI_API_KEY = os.environ.get('GEMINI_API_KEY', 'AIzaSyBdC4BJnV7NMn5tQzsx3r3ZgUJMsJPWH5k')

genai.configure(api_key=GEMINI_API_KEY)

safety_settings = {
    HarmCategory.HARM_CATEGORY_HATE_SPEECH: HarmBlockThreshold.BLOCK_NONE,
    HarmCategory.HARM_CATEGORY_HARASSMENT: HarmBlockThreshold.BLOCK_NONE,
    HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT: HarmBlockThreshold.BLOCK_NONE,
    HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT: HarmBlockThreshold.BLOCK_NONE,
}

model = genai.GenerativeModel('gemini-2.0-flash-exp', safety_settings=safety_settings)

# Language mapping
LANGUAGES = {
    'mr': 'Marathi', 'kn': 'Kannada', 'ta': 'Tamil', 'te': 'Telugu',
    'ml': 'Malayalam', 'gu': 'Gujarati', 'pa': 'Punjabi', 'hi': 'Hindi',
    'bho': 'Bhojpuri', 'kok': 'Konkani', 'ha': 'Haryanvi', 'en': 'English'
}

QUICK_SUGGESTIONS = {
    'weather': 'What is the weather forecast for farming today?',
    'fertilizer': 'What fertilizer should I use for my crops?',
    'pest': 'How do I control pests in my field?',
    'irrigation': 'When should I irrigate my crops?',
    'market': 'What are current market prices for crops?',
    'crop_selection': 'Which crop should I plant this season?',
}

# Comprehensive multilingual farming knowledge base
FARMING_KNOWLEDGE = {
    'fertilizer': {
        'en': 'Use NPK 10-26-26 fertilizer for most crops. Apply 50kg per acre at sowing time and 25kg after 30 days for best results.',
        'hi': 'अधिकांश फसलों के लिए NPK 10-26-26 खाद का उपयोग करें। बुवाई के समय 50 किलो प्रति एकड़ और 30 दिन बाद 25 किलो डालें।',
        'mr': 'बहुतेक पिकांसाठी NPK 10-26-26 खत वापरा। पेरणीच्या वेळी 50 किलो प्रति एकर आणि 30 दिवसांनंतर 25 किलो टाका।',
        'kn': 'ಹೆಚ್ಚಿನ ಬೆಳೆಗಳಿಗೆ NPK 10-26-26 ಗೊಬ್ಬರ ಬಳಸಿ. ಬಿತ್ತನೆ ಸಮಯದಲ್ಲಿ ಪ್ರತಿ ಎಕರೆಗೆ 50 ಕೆಜಿ ಮತ್ತು 30 ದಿನಗಳ ನಂತರ 25 ಕೆಜಿ ಹಾಕಿ.',
        'ta': 'பெரும்பாலான பயிர்களுக்கு NPK 10-26-26 உரத்தைப் பயன்படுத்தவும். விதைப்பின் போது ஏக்கருக்கு 50 கிலோ மற்றும் 30 நாட்களுக்குப் பிறகு 25 கிலோ போடவும்.',
        'te': 'చాలా పంటలకు NPK 10-26-26 ఎరువు వాడండి. విత్తనం వేసేటప్పుడు ఎకరాకు 50 కిలోలు మరియు 30 రోజుల తర్వాత 25 కిలోలు వేయండి.',
        'ml': 'മിക്ക വിളകൾക്കും NPK 10-26-26 വളം ഉപയോഗിക്കുക. വിതയ്ക്കുമ്പോൾ ഏക്കറിന് 50 കിലോയും 30 ദിവസത്തിനുശേഷം 25 കിലോയും ഇടുക.',
        'gu': 'મોટાભાગના પાકો માટે NPK 10-26-26 ખાતરનો ઉપયોગ કરો. વાવણી સમયે એકર દીઠ 50 કિલો અને 30 દિવસ પછી 25 કિલો નાખો.',
        'pa': 'ਜ਼ਿਆਦਾਤਰ ਫਸਲਾਂ ਲਈ NPK 10-26-26 ਖਾਦ ਵਰਤੋ। ਬੀਜਾਈ ਵੇਲੇ ਪ੍ਰਤੀ ਏਕੜ 50 ਕਿਲੋ ਅਤੇ 30 ਦਿਨਾਂ ਬਾਅਦ 25 ਕਿਲੋ ਪਾਓ।',
        'bho': 'जादातर फसल खातिर NPK 10-26-26 खाद के इस्तेमाल करीं। बुवाई के समय 50 किलो प्रति एकड़ आ 30 दिन बाद 25 किलो डालीं।',
        'kok': 'चडशा पिकांखातीर NPK 10-26-26 खत वापरा। पेरणी वेळार एकरा खातीर 50 किलो आनी 30 दिसां उपरांत 25 किलो घाला।',
        'ha': 'जादातर फसलां खातर NPK 10-26-26 खाद का इस्तेमाल करो। बिजाई के बखत 50 किलो प्रति एकड़ अर 30 दिन बाद 25 किलो पाओ।',
    },
    
    'pest_control': {
        'en': 'For pest control, spray Neem oil (30ml per liter) or Imidacloprid in evening hours. Repeat after 7-10 days if needed.',
        'hi': 'कीट नियंत्रण के लिए शाम को नीम का तेल (30 मिली प्रति लीटर) या Imidacloprid स्प्रे करें। जरूरत पड़े तो 7-10 दिन बाद दोहराएं।',
        'mr': 'कीटक नियंत्रणासाठी संध्याकाळी कडुलिंबाचे तेल (30 मिली प्रति लिटर) किंवा Imidacloprid फवारा. गरज असल्यास 7-10 दिवसांनी पुन्हा करा।',
        'kn': 'ಕೀಟ ನಿಯಂತ್ರಣಕ್ಕಾಗಿ ಸಂಜೆ ಬೇವಿನ ಎಣ್ಣೆ (30 ಮಿಲಿ ಪ್ರತಿ ಲೀಟರ್) ಅಥವಾ Imidacloprid ಸಿಂಪಡಿಸಿ. ಅಗತ್ಯವಿದ್ದರೆ 7-10 ದಿನಗಳ ನಂತರ ಪುನರಾವರ್ತಿಸಿ.',
        'ta': 'பூச்சி கட்டுப்பாட்டுக்கு மாலையில் வேப்ப எண்ணெய் (லிட்டருக்கு 30 மிலி) அல்லது Imidacloprid தெளிக்கவும். தேவைப்பட்டால் 7-10 நாட்களுக்குப் பிறகு மீண்டும் செய்யவும்.',
        'te': 'పురుగుల నియంత్రణ కోసం సాయంత్రం వేప నూనె (లీటరుకు 30 మి.లీ) లేదా Imidacloprid స్ప్రే చేయండి. అవసరమైతే 7-10 రోజుల తర్వాత మళ్లీ చేయండి.',
        'ml': 'കീടനിയന്ത്രണത്തിന് വൈകുന്നേരം വേപ്പെണ്ണ (ലിറ്ററിന് 30 മില്ലി) അല്ലെങ്കിൽ Imidacloprid തളിക്കുക. ആവശ്യമെങ്കിൽ 7-10 ദിവസത്തിന് ശേഷം ആവർത്തിക്കുക.',
        'gu': 'જંતુ નિયંત્રણ માટે સાંજે લીમડાનું તેલ (30 મિલી પ્રતિ લિટર) અથવા Imidacloprid છંટકાવ કરો. જરૂર પડે તો 7-10 દિવસ પછી ફરી કરો.',
        'pa': 'ਕੀੜਿਆਂ ਦੇ ਨਿਯੰਤਰਣ ਲਈ ਸ਼ਾਮ ਨੂੰ ਨਿੰਮ ਦਾ ਤੇਲ (30 ਮਿਲੀ ਪ੍ਰਤੀ ਲਿਟਰ) ਜਾਂ Imidacloprid ਛਿੜਕੋ। ਲੋੜ ਪਵੇ ਤਾਂ 7-10 ਦਿਨਾਂ ਬਾਅਦ ਦੁਬਾਰਾ ਕਰੋ।',
        'bho': 'कीड़ा नियंत्रण खातिर साँझ के नीम के तेल (30 मिली प्रति लीटर) भा Imidacloprid स्प्रे करीं। जरूरत पड़े त 7-10 दिन बाद दोहराईं।',
        'kok': 'किडो नियंत्रण खातीर सांजेर कडुनिंबाचें तेल (30 मिली प्रति लिटर) वा Imidacloprid फवारा. गरज आसल्यार 7-10 दिसांनी परत करा।',
        'ha': 'कीड़ा नियंत्रण खातर सांझ के नीम का तेल (30 मिली प्रति लीटर) या Imidacloprid स्प्रे करो। जरूरत पड़े तो 7-10 दिन बाद दोहराओ।',
    },
    
    'irrigation': {
        'en': 'Water crops early morning or evening. For rice, maintain 2-3 inches standing water. For wheat, irrigate every 20-25 days.',
        'hi': 'फसलों को सुबह या शाम को पानी दें। धान के लिए 2-3 इंच खड़ा पानी रखें। गेहूं के लिए हर 20-25 दिन में सिंचाई करें।',
        'mr': 'पिकांना सकाळी किंवा संध्याकाळी पाणी द्या. भातासाठी 2-3 इंच उभे पाणी ठेवा. गव्हासाठी दर 20-25 दिवसांनी पाणी द्या.',
        'kn': 'ಬೆಳಿಗ್ಗೆ ಅಥವಾ ಸಂಜೆ ಬೆಳೆಗಳಿಗೆ ನೀರು ನೀಡಿ. ಭತ್ತಕ್ಕೆ 2-3 ಇಂಚು ನಿಂತ ನೀರು ಇರಿಸಿ. ಗೋಧಿಗೆ ಪ್ರತಿ 20-25 ದಿನಗಳಿಗೊಮ್ಮೆ ನೀರು ನೀಡಿ.',
        'ta': 'காலை அல்லது மாலையில் பயிர்களுக்கு தண்ணீர் கொடுக்கவும். நெல்லுக்கு 2-3 அங்குல நீர் நிலைத்திருக்க வைக்கவும். கோதுமைக்கு 20-25 நாட்களுக்கு ஒருமுறை நீர் பாய்ச்சவும்.',
        'te': 'పంటలకు ఉదయం లేదా సాయంత్రం నీరు పెట్టండి. వరికి 2-3 అంగుళాల నీటి స్థాయి ఉంచండి. గోధుమకు ప్రతి 20-25 రోజులకు నీరు పెట్టండి.',
        'ml': 'വിളകൾക്ക് രാവിലെയോ വൈകുന്നേരമോ വെള്ളം നൽകുക. നെല്ലിന് 2-3 ഇഞ്ച് നിൽക്കുന്ന വെള്ളം സൂക്ഷിക്കുക. ഗോതമ്പിന് ഓരോ 20-25 ദിവസത്തിലും വെള്ളം നൽകുക.',
        'gu': 'પાકોને સવારે અથવા સાંજે પાણી આપો. ચોખા માટે 2-3 ઇંચ ઊભું પાણી રાખો. ઘઉં માટે દર 20-25 દિવસે પાણી આપો.',
        'pa': 'ਫਸਲਾਂ ਨੂੰ ਸਵੇਰੇ ਜਾਂ ਸ਼ਾਮ ਪਾਣੀ ਦਿਓ। ਝੋਨੇ ਲਈ 2-3 ਇੰਚ ਖੜ੍ਹਾ ਪਾਣੀ ਰੱਖੋ। ਕਣਕ ਲਈ ਹਰ 20-25 ਦਿਨਾਂ ਬਾਅਦ ਪਾਣੀ ਦਿਓ।',
        'bho': 'फसल के सुबह भा साँझ पानी दीं। धान खातिर 2-3 इंच खड़ा पानी रखीं। गेहूँ खातिर हर 20-25 दिन में सिंचाई करीं।',
        'kok': 'पिकांक सकाळीं वा सांजेर उदक द्या. भाता खातीर 2-3 इंच उभें उदक दवरा. गंव खातीर दर 20-25 दिसांनी उदक द्या.',
        'ha': 'फसलां नै सवेरे या सांझ पाणी द्यो। धान खातर 2-3 इंच खड़ा पाणी राखो। गेहूं खातर हर 20-25 दिन सिंचाई करो।',
    },
    
    'weather': {
        'en': 'Check local weather forecast before farming. Avoid spraying pesticides before rain. Best temperature for farming is 20-30°C with moderate humidity.',
        'hi': 'खेती से पहले स्थानीय मौसम पूर्वानुमान देखें। बारिश से पहले कीटनाशक छिड़काव न करें। खेती के लिए सबसे अच्छा तापमान 20-30°C मध्यम आर्द्रता के साथ है।',
        'mr': 'शेती करण्यापूर्वी स्थानिक हवामान अंदाज पहा. पावसापूर्वी कीटकनाशक फवारणी टाळा. शेतीसाठी सर्वोत्तम तापमान 20-30°C मध्यम आर्द्रतेसह आहे.',
        'kn': 'ಕೃಷಿಗೆ ಮುನ್ನ ಸ್ಥಳೀಯ ಹವಾಮಾನ ಮುನ್ಸೂಚನೆ ಪರಿಶೀಲಿಸಿ. ಮಳೆಗೆ ಮುನ್ನ ಕೀಟನಾಶಕ ಸಿಂಪಡಿಸುವುದನ್ನು ತಪ್ಪಿಸಿ. ಕೃಷಿಗೆ ಉತ್ತಮ ತಾಪಮಾನ 20-30°C ಮಧ್ಯಮ ತೇವಾಂಶದೊಂದಿಗೆ.',
        'ta': 'விவசாயத்திற்கு முன் உள்ளூர் வானிலை முன்னறிவிப்பைப் பார்க்கவும். மழைக்கு முன் பூச்சிக்கொல்லி தெளிப்பதைத் தவிர்க்கவும். விவசாயத்திற்கு சிறந்த வெப்பநிலை 20-30°C மிதமான ஈரப்பதத்துடன்.',
        'te': 'వ్యవసాయానికి ముందు స్థానిక వాతావరణ సూచనలు చూడండి. వర్షానికి ముందు పురుగుమందు స్ప్రే చేయడం మానండి. వ్యవసాయానికి ఉత్తమ ఉష్ణోగ్రత 20-30°C మధ్యస్థ తేమతో.',
        'ml': 'കൃഷിക്ക് മുമ്പ് പ്രാദേശിക കാലാവസ്ഥ പ്രവചനം പരിശോധിക്കുക. മഴയ്ക്ക് മുമ്പ് കീടനാശിനി തളിക്കുന്നത് ഒഴിവാക്കുക. കൃഷിക്ക് മികച്ച താപനില 20-30°C മിതമായ ആർദ്രതയോടെ.',
        'gu': 'ખેતી કરતાં પહેલાં સ્થાનિક હવામાન આગાહી તપાસો. વરસાદ પહેલાં જંતુનાશક છંટકાવ ટાળો. ખેતી માટે શ્રેષ્ઠ તાપમાન 20-30°C મધ્યમ ભેજ સાથે છે.',
        'pa': 'ਖੇਤੀ ਤੋਂ ਪਹਿਲਾਂ ਸਥਾਨਕ ਮੌਸਮ ਪੂਰਵ ਅਨੁਮਾਨ ਦੇਖੋ। ਬਾਰਿਸ਼ ਤੋਂ ਪਹਿਲਾਂ ਕੀਟਨਾਸ਼ਕ ਛਿੜਕਾਅ ਨਾ ਕਰੋ। ਖੇਤੀ ਲਈ ਸਭ ਤੋਂ ਵਧੀਆ ਤਾਪਮਾਨ 20-30°C ਮੱਧਮ ਨਮੀ ਨਾਲ ਹੈ।',
        'bho': 'खेती से पहिले स्थानीय मौसम के पूर्वानुमान देखीं। बरखा से पहिले कीटनाशक छिड़काव ना करीं। खेती खातिर सबसे बढ़िया तापमान 20-30°C मध्यम नमी के साथ बा।',
        'kok': 'शेती करचे पयलीं स्थानीक हवामान अदमास पळयात. पावसा पयलीं किडोनाशक फवारणी टाळात. शेतीखातीर सर्वोत्तम तापमान 20-30°C मध्यम आर्द्रताय लागून.',
        'ha': 'खेती तै पहल्यां स्थानीय मौसम पूर्वानुमान देखो। बारिश तै पहल्यां कीटनाशक छिड़काव ना करो। खेती खातर सबतै बढ़िया तापमान 20-30°C मध्यम नमी कै साथ सै।',
    },
    
    'crop_selection': {
        'en': 'Kharif season: Rice, Cotton, Soybean, Maize. Rabi season: Wheat, Mustard, Chickpea. Zaid season: Cucumber, Watermelon. Choose based on soil type and water availability.',
        'hi': 'खरीफ मौसम: धान, कपास, सोयाबीन, मक्का। रबी मौसम: गेहूं, सरसों, चना। जायद मौसम: खीरा, तरबूज। मिट्टी के प्रकार और पानी की उपलब्धता के आधार पर चुनें।',
        'mr': 'खरीप हंगाम: तांदूळ, कापूस, सोयाबीन, मका. रब्बी हंगाम: गहू, मोहरी, हरभरा. जायद हंगाम: काकडी, टरबूज. माती प्रकार आणि पाणी उपलब्धतेच्या आधारे निवडा.',
        'kn': 'ಖರೀಫ್ ಋತು: ಭತ್ತ, ಹತ್ತಿ, ಸೋಯಾಬೀನ್, ಜೋಳ. ರಬ್ಬಿ ಋತು: ಗೋಧಿ, ಸಾಸಿವೆ, ಕಡಲೆ. ಝಾಯಿದ್ ಋತು: ಸೌತೆಕಾಯಿ, ಕಲ್ಲಂಗಡಿ. ಮಣ್ಣಿನ ಪ್ರಕಾರ ಮತ್ತು ನೀರಿನ ಲಭ್ಯತೆಯ ಆಧಾರದ ಮೇಲೆ ಆರಿಸಿ.',
        'ta': 'கரீஃப் பருவம்: நெல், பருத்தி, சோயா, சோளம். ரபி பருவம்: கோதுமை, கடுகு, கொண்டைக்கடலை. ஜாயித் பருவம்: வெள்ளரி, தர்பூசணி. மண் வகை மற்றும் நீர் கிடைப்பின் அடிப்படையில் தேர்வு செய்யவும்.',
        'te': 'ఖరీఫ్ సీజన్: వరి, పత్తి, సోయాబీన్, మొక్కజొన్న. రబీ సీజన్: గోధుమ, ఆవాలు, శనగలు. జాయిద్ సీజన్: దోసకాయ, పుచ్చకాయ. నేల రకం మరియు నీటి లభ్యత ఆధారంగా ఎంచుకోండి.',
        'ml': 'ഖരീഫ് സീസൺ: നെല്ല്, പരുത്തി, സോയാബീൻ, ചോളം. റബി സീസൺ: ഗോതമ്പ്, കടുക്, കടല. സായിദ് സീസൺ: വെള്ളരി, തണ്ണിമത്തൻ. മണ്ണിന്റെ തരവും ജല ലഭ്യതയും അടിസ്ഥാനമാക്കി തിരഞ്ഞെടുക്കുക.',
        'gu': 'ખરીફ મોસમ: ચોખા, કપાસ, સોયાબીન, મકાઈ. રબી મોસમ: ઘઉં, સરસવ, ચણા. ઝાયદ મોસમ: કાકડી, તરબૂચ. જમીનના પ્રકાર અને પાણીની ઉપલબ્ધતાના આધારે પસંદ કરો.',
        'pa': 'ਖਰੀਫ ਸੀਜ਼ਨ: ਝੋਨਾ, ਕਪਾਹ, ਸੋਇਆਬੀਨ, ਮੱਕੀ. ਰਬੀ ਸੀਜ਼ਨ: ਕਣਕ, ਰਾਈ, ਛੋਲੇ. ਜਾਇਦ ਸੀਜ਼ਨ: ਖੀਰਾ, ਤਰਬੂਜ਼. ਮਿੱਟੀ ਦੀ ਕਿਸਮ ਅਤੇ ਪਾਣੀ ਦੀ ਉਪਲਬਧਤਾ ਦੇ ਆਧਾਰ \'ਤੇ ਚੁਣੋ.',
        'bho': 'खरीफ मौसम: धान, कपास, सोयाबीन, मक्का। रबी मौसम: गेहूँ, सरसों, चना। जायद मौसम: खीरा, तरबूज। माटी के प्रकार आ पानी के उपलब्धता के आधार पर चुनीं।',
        'kok': 'खरीफ हंगाम: भात, कापूस, सोयाबीन, मका. रब्बी हंगाम: गंव, मोहरी, हरभरा. जायद हंगाम: काकडी, कलिंगड. माती प्रकार आनी उदक उपलब्धताचे आधारान निवडात.',
        'ha': 'खरीफ मौसम: धान, कपास, सोयाबीन, मक्का। रबी मौसम: गेहूं, सरसों, चना। जायद मौसम: खीरा, तरबूज। माटी के प्रकार अर पाणी की उपलब्धता के आधार पै चुनो।',
    },
    
    'soil_management': {
        'en': 'Test soil pH every year. Add organic compost 5-10 tons per acre. For acidic soil, add lime. For alkaline soil, add gypsum. Maintain proper drainage.',
        'hi': 'हर साल मिट्टी का pH टेस्ट करें। 5-10 टन प्रति एकड़ जैविक खाद डालें। अम्लीय मिट्टी के लिए चूना डालें। क्षारीय मिट्टी के लिए जिप्सम डालें। उचित जल निकासी बनाए रखें।',
        'mr': 'दर वर्षी मातीची pH चाचणी करा. एकर दरी 5-10 टन सेंद्रिय खत टाका. आम्लयुक्त मातीसाठी चुना टाका. क्षारयुक्त मातीसाठी जिप्सम टाका. योग्य पाणी निचरा राखा.',
        'kn': 'ಪ್ರತಿ ವರ್ಷ ಮಣ್ಣಿನ pH ಪರೀಕ್ಷೆ ಮಾಡಿ. ಎಕರೆಗೆ 5-10 ಟನ್ ಸಾವಯವ ಗೊಬ್ಬರ ಸೇರಿಸಿ. ಆಮ್ಲೀಯ ಮಣ್ಣಿಗೆ ಸುಣ್ಣ ಸೇರಿಸಿ. ಕ್ಷಾರೀಯ ಮಣ್ಣಿಗೆ ಜಿಪ್ಸಮ್ ಸೇರಿಸಿ. ಸರಿಯಾದ ನೀರು ಹರಿವು ಇರಿಸಿ.',
        'ta': 'ஒவ்வொரு ஆண்டும் மண் pH சோதனை செய்யவும். ஏக்கருக்கு 5-10 டன் கரிம உரம் சேர்க்கவும். அமில மண்ணுக்கு சுண்ணாம்பு சேர்க்கவும். காரமண் க்கு ஜிப்சம் சேர்க்கவும். சரியான வடிகால் பராமரிக்கவும்.',
        'te': 'ప్రతి సంవత్సరం నేల pH పరీక్షించండి. ఎకరాకు 5-10 టన్నుల సేంద్రీయ ఎరువు వేయండి. ఆమ్ల నేలకు సున్నం వేయండి. క్షార నేలకు జిప్సం వేయండి. సరైన నీటి ప్రవాహం నిర్వహించండి.',
        'ml': 'എല്ലാ വർഷവും മണ്ണിന്റെ pH പരിശോധിക്കുക. ഏക്കറിന് 5-10 ടൺ ജൈവ വളം ചേർക്കുക. അമ്ല മണ്ണിന് കുമ്മായം ചേർക്കുക. ക്ഷാര മണ്ണിന് ജിപ്സം ചേർക്കുക. ശരിയായ വാൽച്ചത് നിലനിർത്തുക.',
        'gu': 'દર વર્ષે જમીનનું pH પરીક્ષણ કરો. એકર દીઠ 5-10 ટન કાર્બનિક ખાતર નાખો. એસિડિક જમીન માટે ચૂનો નાખો. ક્ષારયુક્ત જમીન માટે જીપસમ નાખો. યોગ્ય ડ્રેનેજ જાળવો.',
        'pa': 'ਹਰ ਸਾਲ ਮਿੱਟੀ ਦਾ pH ਟੈਸਟ ਕਰੋ। ਐਕੜ ਵਿਚ 5-10 ਟਨ ਜੈਵਿਕ ਖਾਦ ਪਾਓ। ਤੇਜ਼ਾਬੀ ਮਿੱਟੀ ਲਈ ਚੂਨਾ ਪਾਓ। ਖਾਰੀ ਮਿੱਟੀ ਲਈ ਜਿਪਸਮ ਪਾਓ। ਠੀਕ ਡਰੇਨੇਜ ਬਣਾਏ ਰੱਖੋ।',
        'bho': 'हर साल माटी के pH टेस्ट करीं। 5-10 टन प्रति एकड़ जैविक खाद डालीं। अम्लीय माटी खातिर चूना डालीं। क्षारीय माटी खातिर जिप्सम डालीं। उचित पानी निकासी बनाए रखीं।',
        'kok': 'दर वर्सा माती pH चाचणी करात. एकरा खातीर 5-10 टन सेंद्रिय खत घालात. आम्लीय माती खातीर चुनो घालात. क्षारीय माती खातीर जिप्सम घालात. योग्य उदक निचरो दवरात.',
        'ha': 'हर साल माटी का pH टेस्ट करो। 5-10 टन प्रति एकड़ जैविक खाद पाओ। अम्लीय माटी खातर चूना पाओ। क्षारीय माटी खातर जिप्सम पाओ। सही पाणी निकास बणाए राखो।',
    },
    
    'market_prices': {
        'en': 'Check daily market prices at your local mandi or use government apps like e-NAM. Sell when prices are high. Store properly to sell in off-season for better profits.',
        'hi': 'अपनी स्थानीय मंडी में रोज बाजार भाव देखें या e-NAM जैसे सरकारी ऐप इस्तेमाल करें। जब दाम ऊंचे हों तब बेचें। बेहतर मुनाफे के लिए ऑफ सीजन में बेचने हेतु सही तरीके से भंडारण करें।',
        'mr': 'तुमच्या स्थानिक मंडीत रोज बाजार भाव पहा किंवा e-NAM सारखे सरकारी अॅप वापरा. किंमती जास्त असताना विका. चांगल्या नफ्यासाठी ऑफ सीझनमध्ये विकण्यासाठी योग्यरित्या साठवा.',
        'kn': 'ನಿಮ್ಮ ಸ್ಥಳೀಯ ಮಂಡಿಯಲ್ಲಿ ಪ್ರತಿದಿನ ಮಾರುಕಟ್ಟೆ ಬೆಲೆಗಳನ್ನು ಪರಿಶೀಲಿಸಿ ಅಥವಾ e-NAM ನಂತಹ ಸರ್ಕಾರಿ ಅಪ್ಲಿಕೇಶನ್‌ಗಳನ್ನು ಬಳಸಿ. ಬೆಲೆಗಳು ಹೆಚ್ಚಿರುವಾಗ ಮಾರಾಟ ಮಾಡಿ. ಉತ್ತಮ ಲಾಭಕ್ಕಾಗಿ ಆಫ್ ಸೀಸನ್‌ನಲ್ಲಿ ಮಾರಾಟ ಮಾಡಲು ಸರಿಯಾಗಿ ಸಂಗ್ರಹಿಸಿ.',
        'ta': 'உங்கள் உள்ளூர் மண்டியில் தினசரி சந்தை விலைகளைச் சரிபார்க்கவும் அல்லது e-NAM போன்ற அரசு பயன்பாடுகளைப் பயன்படுத்தவும். விலைகள் அதிகமாக இருக்கும் போது விற்கவும். சிறந்த லாபத்திற்காக சீசன் இல்லாத காலத்தில் விற்க சரியாக சேமிக்கவும்.',
        'te': 'మీ స్థానిక మండిలో రోజువారీ మార్కెట్ ధరలను తనిఖీ చేయండి లేదా e-NAM వంటి ప్రభుత్వ యాప్‌లను ఉపయోగించండి. ధరలు ఎక్కువగా ఉన్నప్పుడు అమ్మండి. మెరుగైన లాభాల కోసం ఆఫ్ సీజన్‌లో అమ్మడానికి సరిగ్గా నిల్వ చేయండి.',
        'ml': 'നിങ്ങളുടെ പ്രാദേശിക മണ്ഡിയിൽ ദൈനംദിന വിപണി വിലകൾ പരിശോധിക്കുക അല്ലെങ്കിൽ e-NAM പോലുള്ള സർക്കാർ ആപ്പുകൾ ഉപയോഗിക്കുക. വില ഉയർന്നപ്പോൾ വിൽക്കുക. മികച്ച ലാഭത്തിനായി ഓഫ് സീസണിൽ വിൽക്കാൻ ശരിയായി സൂക്ഷിക്കുക.',
        'gu': 'તમારા સ્થાનિક મંડીમાં દૈનિક બજાર ભાવ તપાસો અથવા e-NAM જેવી સરકારી એપ્લિકેશનનો ઉપયોગ કરો. જ્યારે ભાવ ઊંચા હોય ત્યારે વેચો. વધુ સારા નફા માટે ઑફ-સીઝનમાં વેચવા માટે યોગ્ય રીતે સંગ્રહ કરો.',
        'pa': 'ਆਪਣੀ ਸਥਾਨਕ ਮੰਡੀ ਵਿੱਚ ਰੋਜ਼ਾਨਾ ਮਾਰਕੀਟ ਭਾਅ ਚੈੱਕ ਕਰੋ ਜਾਂ e-NAM ਵਰਗੇ ਸਰਕਾਰੀ ਐਪ ਵਰਤੋ। ਜਦੋਂ ਭਾਅ ਵੱਧ ਹੋਣ ਤਾਂ ਵੇਚੋ। ਬਿਹਤਰ ਮੁਨਾਫੇ ਲਈ ਆਫ-ਸੀਜ਼ਨ ਵਿੱਚ ਵੇਚਣ ਲਈ ਸਹੀ ਢੰਗ ਨਾਲ ਸਟੋਰ ਕਰੋ।',
        'bho': 'अपन स्थानीय मंडी में रोज बाजार भाव देखीं भा e-NAM जइसन सरकारी ऐप इस्तेमाल करीं। जब दाम ऊंच होखे तब बेचीं। बढ़िया मुनाफा खातिर ऑफ सीजन में बेचे खातिर सही तरीका से भंडारण करीं।',
        'kok': 'तुमच्या स्थानीक मंडींत रोज बाजार भाव पळयात वा e-NAM सारकी सरकारी अॅप वापरात. किमती चड आसतना विकात. बरे फायदा खातीर ऑफ सीझनांत विकपाखातीर बरेच तरेन साठोवात.',
        'ha': 'अपणी स्थानीय मंडी में रोज बाजार भाव देखो या e-NAM जिसी सरकारी ऐप इस्तेमाल करो। जब दाम ऊंचे होवे तो बेचो। बढ़िया मुनाफे खातर ऑफ सीजन में बेचण खातर सही तरीके तै भंडारण करो।',
    },
    
    'disease_control': {
        'en': 'For fungal diseases, spray Mancozeb or Copper oxychloride. For bacterial diseases, use Streptomycin. Remove infected plants immediately. Maintain field cleanliness.',
        'hi': 'फंगल रोगों के लिए Mancozeb या Copper oxychloride स्प्रे करें। बैक्टीरियल रोगों के लिए Streptomycin का उपयोग करें। संक्रमित पौधों को तुरंत हटाएं। खेत की सफाई बनाए रखें।',
        'mr': 'बुरशीजन्य रोगांसाठी Mancozeb किंवा Copper oxychloride फवारा. जिवाणूजन्य रोगांसाठी Streptomycin वापरा. संक्रमित झाडे ताबडतोब काढा. शेताची स्वच्छता राखा.',
        'kn': 'ಶಿಲೀಂಧ್ರ ರೋಗಗಳಿಗೆ Mancozeb ಅಥವಾ Copper oxychloride ಸಿಂಪಡಿಸಿ. ಬ್ಯಾಕ್ಟೀರಿಯಾ ರೋಗಗಳಿಗೆ Streptomycin ಬಳಸಿ. ಸೋಂಕಿತ ಸಸ್ಯಗಳನ್ನು ತಕ್ಷಣ ತೆಗೆದುಹಾಕಿ. ಹೊಲದ ಶುಚಿತ್ವವನ್ನು ನಿರ್ವಹಿಸಿ.',
        'ta': 'பூஞ்சை நோய்களுக்கு Mancozeb அல்லது Copper oxychloride தெளிக்கவும். பாக்டீரியா நோய்களுக்கு Streptomycin பயன்படுத்தவும். பாதிக்கப்பட்ட தாவரங்களை உடனடியாக அகற்றவும். வயல் சுத்தத்தை பராமரிக்கவும்.',
        'te': 'శిలీంధ్ర వ్యాధులకు Mancozeb లేదా Copper oxychloride స్ప్రే చేయండి. బ్యాక్టీరియా వ్యాధులకు Streptomycin ఉపయోగించండి. సోకిన మొక్కలను వెంటనే తొలగించండి. పొలం పరిశుభ్రత నిర్వహించండి.',
        'ml': 'ഫംഗൽ രോഗങ്ങൾക്ക് Mancozeb അല്ലെങ്കിൽ Copper oxychloride തളിക്കുക. ബാക്ടീരിയ രോഗങ്ങൾക്ക് Streptomycin ഉപയോഗിക്കുക. രോഗബാധിതമായ ചെടികൾ ഉടൻ നീക്കംചെയ്യുക. വയൽ ശുചിത്വം പാലിക്കുക.',
        'gu': 'ફૂગના રોગો માટે Mancozeb અથવા Copper oxychloride છંટકાવ કરો. બેક્ટેરિયલ રોગો માટે Streptomycin વાપરો. ચેપગ્રસ્ત છોડને તાત્કાલિક દૂર કરો. ખેતરની સ્વચ્છતા જાળવો.',
        'pa': 'ਉੱਲੀ ਦੇ ਰੋਗਾਂ ਲਈ Mancozeb ਜਾਂ Copper oxychloride ਛਿੜਕੋ। ਬੈਕਟੀਰੀਅਲ ਰੋਗਾਂ ਲਈ Streptomycin ਵਰਤੋ। ਸੰਕਰਮਿਤ ਪੌਦਿਆਂ ਨੂੰ ਤੁਰੰਤ ਹਟਾਓ। ਖੇਤ ਦੀ ਸਫਾਈ ਬਣਾਏ ਰੱਖੋ।',
        'bho': 'फंगल बीमारी खातिर Mancozeb भा Copper oxychloride स्प्रे करीं। बैक्टीरियल बीमारी खातिर Streptomycin के इस्तेमाल करीं। संक्रमित पौधा के तुरंत हटाईं। खेत के सफाई बनाए रखीं।',
        'kok': 'बुरशीजन्य रोगांखातीर Mancozeb वा Copper oxychloride फवारात. जीवाणूजन्य रोगांखातीर Streptomycin वापरात. संक्रमित रोपां तोंडाळक काडात. शेताची स्वच्छताय दवरात.',
        'ha': 'फंगल बीमारी खातर Mancozeb या Copper oxychloride स्प्रे करो। बैक्टीरियल बीमारी खातर Streptomycin का इस्तेमाल करो। संक्रमित पौधा नै तोड़ के हटाओ। खेत की साफ-सफाई बणाए राखो।',
    },
    
    'organic_farming': {
        'en': 'Use vermicompost, cow dung, and green manure. For pest control, use Neem, garlic spray. Crop rotation prevents diseases. Avoid chemical pesticides and fertilizers.',
        'hi': 'वर्मीकम्पोस्ट, गोबर की खाद और हरी खाद का उपयोग करें। कीट नियंत्रण के लिए नीम, लहसुन का स्प्रे करें। फसल चक्र से बीमारियां रुकती हैं। रासायनिक कीटनाशक और उर्वरक से बचें।',
        'mr': 'वर्मीकम्पोस्ट, शेणखत आणि हिरवे खत वापरा. कीटक नियंत्रणासाठी कडुलिंब, लसूण फवारा. पीक फिरवामुळे रोग टळतात. रासायनिक कीटकनाशके आणि खते टाळा.',
        'kn': 'ವರ್ಮಿಕಾಂಪೋಸ್ಟ್, ಹಸುಗೊಬ್ಬರ, ಮತ್ತು ಹಸಿರು ಗೊಬ್ಬರ ಬಳಸಿ. ಕೀಟ ನಿಯಂತ್ರಣಕ್ಕಾಗಿ ಬೇವು, ಬೆಳ್ಳುಳ್ಳಿ ಸಿಂಪಡಿಸಿ. ಬೆಳೆ ಸರದಿ ರೋಗಗಳನ್ನು ತಡೆಯುತ್ತದೆ. ರಾಸಾಯನಿಕ ಕೀಟನಾಶಕಗಳು ಮತ್ತು ಗೊಬ್ಬರಗಳನ್ನು ತಪ್ಪಿಸಿ.',
        'ta': 'மண்புழு உரம், மாட்டு எரு, பசுந்தாள் உரம் பயன்படுத்தவும். பூச்சி கட்டுப்பாட்டுக்கு வேப்பம், பூண்டு தெளிக்கவும். பயிர் சுழற்சி நோய்களை தடுக்கிறது. ரசாயன பூச்சிக்கொல்லிகள் மற்றும் உரங்களை தவிர்க்கவும்.',
        'te': 'వర్మీకంపోస్ట్, ఆవు పేడ, పచ్చి ఎరువు వాడండి. పురుగుల నియంత్రణకు వేప, వెల్లుల్లి స్ప్రే చేయండి. పంట మార్పిడి వ్యాధులను నివారిస్తుంది. రసాయన పురుగుమందులు మరియు ఎరువులను తప్పించండి.',
        'ml': 'വേർമികമ്പോസ്റ്റ്, പശുവളം, പച്ചിലവളം ഉപയോഗിക്കുക. കീടനിയന്ത്രണത്തിന് വേപ്പ്, വെളുത്തുള്ളി തളിക്കുക. വിള മാറ്റം രോഗങ്ങളെ തടയുന്നു. രാസ കീടനാശിനികളും വളങ്ങളും ഒഴിവാക്കുക.',
        'gu': 'વર્મીકમ્પોસ્ટ, ગાયનું છાણ, લીલા ખાતરનો ઉપયોગ કરો. જંતુ નિયંત્રણ માટે લીમડો, લસણનો છંટકાવ કરો. પાક ફેરબદલ રોગ રોકે છે. રાસાયણિક જંતુનાશકો અને ખાતરો ટાળો.',
        'pa': 'ਵਰਮੀਕੰਪੋਸਟ, ਗਾਂ ਦਾ ਗੋਹਾ, ਅਤੇ ਹਰੀ ਖਾਦ ਵਰਤੋ। ਕੀੜੇ ਨਿਯੰਤਰਣ ਲਈ ਨਿੰਮ, ਲਸਣ ਛਿੜਕੋ। ਫਸਲ ਚੱਕਰ ਬੀਮਾਰੀਆਂ ਰੋਕਦਾ ਹੈ। ਰਸਾਇਣਕ ਕੀਟਨਾਸ਼ਕ ਅਤੇ ਖਾਦਾਂ ਤੋਂ ਪਰਹੇਜ਼ ਕਰੋ।',
        'bho': 'वर्मीकम्पोस्ट, गोबर के खाद आ हरियर खाद के इस्तेमाल करीं। कीड़ा नियंत्रण खातिर नीम, लहसुन के स्प्रे करीं। फसल चक्र से बीमारी रुकेला। रासायनिक कीटनाशक आ उर्वरक से बचीं।',
        'kok': 'वर्मीकम्पोस्ट, गायीचें शेण, आनी पाचवें खत वापरात. किडो नियंत्रण खातीर कडुनिंब, लसूण फवारात. पीक फिरोवण रोग टळटा. रासायनिक किडोनाशक आनी खतां टाळात.',
        'ha': 'वर्मीकम्पोस्ट, गोबर की खाद अर हरी खाद का इस्तेमाल करो। कीड़ा नियंत्रण खातर नीम, लहसुन का स्प्रे करो। फसल बदलाव तै बीमारी रुकै सै। रासायनिक कीटनाशक अर उर्वरक तै बचो।',
    },
}

@app.route('/')
def home():
    """Landing page"""
    return render_template('home.html')

@app.route('/chat')
def chat_page():
    """Chatbot interface"""
    return render_template('chat.html')

@app.route('/chat', methods=['POST'])
def chat():
    """Process user query using Google Gemini API"""
    try:
        data = request.json
        user_message = data.get('message', '')
        language_code = data.get('language', 'en')
        language_name = LANGUAGES.get(language_code, 'English')
        
        prompt = f"Answer this farmer's question in {language_name} language (keep it short, 2-3 sentences): {user_message}"
        
        print(f"🔄 Query: {user_message}")
        
        try:
            response = model.generate_content(prompt)
            ai_response = response.text.strip()
            print(f"✅ Gemini Response: {ai_response[:80]}")
        except Exception as api_error:
            print(f"⚠️ Gemini API failed: {str(api_error)}")
            ai_response = get_comprehensive_answer(user_message, language_code)
            print(f"📚 Using fallback answer")
        
        return jsonify({
            'success': True,
            'response': ai_response,
            'suggestions': generate_suggestions(user_message)
        })
    
    except Exception as e:
        print(f"❌ Error: {e}")
        return jsonify({
            'success': True,
            'response': get_comprehensive_answer(user_message, language_code),
            'suggestions': []
        })

def get_comprehensive_answer(question, language_code):
    """Intelligent fallback with comprehensive farming knowledge in all languages"""
    q = question.lower()
    
    # Determine topic
    if any(word in q for word in ['fertilizer', 'खाद', 'खत', 'ಗೊಬ್ಬರ', 'உரம்', 'ఎరువు', 'വളം', 'ખાતર', 'ਖਾਦ']):
        return FARMING_KNOWLEDGE['fertilizer'].get(language_code, FARMING_KNOWLEDGE['fertilizer']['en'])
    
    elif any(word in q for word in ['pest', 'insect', 'कीट', 'कीटक', 'ಕೀಟ', 'பூச்சி', 'పురుగు', 'കീടം', 'જંતુ', 'ਕੀੜੇ', 'किडो']):
        return FARMING_KNOWLEDGE['pest_control'].get(language_code, FARMING_KNOWLEDGE['pest_control']['en'])
    
    elif any(word in q for word in ['water', 'irrigation', 'पानी', 'सिंचन', 'सिंचाई', 'ನೀರು', 'தண்ணீர்', 'నీరు', 'വെള്ളം', 'પાણી', 'ਪਾਣੀ', 'उदक']):
        return FARMING_KNOWLEDGE['irrigation'].get(language_code, FARMING_KNOWLEDGE['irrigation']['en'])
    
    elif any(word in q for word in ['weather', 'rain', 'मौसम', 'हवामान', 'ಹವಾಮಾನ', 'வானிலை', 'వాతావరణం', 'കാലാവസ്ഥ', 'હવામાન', 'ਮੌਸਮ', 'बरखा', 'पाऊस']):
        return FARMING_KNOWLEDGE['weather'].get(language_code, FARMING_KNOWLEDGE['weather']['en'])
    
    elif any(word in q for word in ['crop', 'plant', 'seed', 'फसल', 'पीक', 'ಬೆಳೆ', 'பயிர்', 'పంట', 'വിള', 'પાક', 'ਫਸਲ', 'बीज', 'roप']):
        return FARMING_KNOWLEDGE['crop_selection'].get(language_code, FARMING_KNOWLEDGE['crop_selection']['en'])
    
    elif any(word in q for word in ['soil', 'land', 'मिट्टी', 'माटी', 'ಮಣ್ಣು', 'மண்', 'నేల', 'മണ്ണ്', 'જમીન', 'ਮਿੱਟੀ']):
        return FARMING_KNOWLEDGE['soil_management'].get(language_code, FARMING_KNOWLEDGE['soil_management']['en'])
    
    elif any(word in q for word in ['price', 'market', 'sell', 'बाजार', 'मंडी', 'ಮಾರುಕಟ್ಟೆ', 'சந்தை', 'మార్కెట్', 'വിപണി', 'બજાર', 'ਮਾਰਕੀਟ', 'विकपा']):
        return FARMING_KNOWLEDGE['market_prices'].get(language_code, FARMING_KNOWLEDGE['market_prices']['en'])
    
    elif any(word in q for word in ['disease', 'sick', 'बीमारी', 'रोग', 'ರೋಗ', 'நோய்', 'వ్యాధి', 'രോഗം', 'રોગ', 'ਬੀਮਾਰੀ']):
        return FARMING_KNOWLEDGE['disease_control'].get(language_code, FARMING_KNOWLEDGE['disease_control']['en'])
    
    elif any(word in q for word in ['organic', 'natural', 'जैविक', 'सेंद्रिय', 'ಸಾವಯವ', 'இயற்கை', 'సేంద్రీయ', 'ജൈവ', 'કાર્બનિક', 'ਜੈਵਿਕ']):
        return FARMING_KNOWLEDGE['organic_farming'].get(language_code, FARMING_KNOWLEDGE['organic_farming']['en'])
    
    # Default response if no match
    default_responses = {
        'en': 'I can help you with farming questions about fertilizers, pest control, irrigation, weather, crops, soil, market prices, diseases, and organic farming. Please ask your specific question.',
        'hi': 'मैं आपको खाद, कीट नियंत्रण, सिंचाई, मौसम, फसलें, मिट्टी, बाजार भाव, बीमारियां और जैविक खेती के बारे में मदद कर सकता हूं। कृपया अपना विशिष्ट सवाल पूछें।',
        'mr': 'मी तुम्हाला खत, कीटक नियंत्रण, सिंचन, हवामान, पिके, माती, बाजार भाव, रोग आणि सेंद्रिय शेती बद्दल मदत करू शकतो. कृपया तुमचा विशिष्ट प्रश्न विचारा.',
    }
    
    return default_responses.get(language_code, default_responses['en'])

def generate_suggestions(query):
    suggestions = ['weather', 'fertilizer', 'pest', 'irrigation', 'crop_selection', 'market']
    return [{'type': s, 'text': QUICK_SUGGESTIONS[s]} for s in suggestions[:4]]

@app.route('/translate', methods=['POST'])
def translate_suggestion():
    try:
        data = request.json
        text = data.get('text', '')
        return jsonify({'success': True, 'translated': text})
    except:
        return jsonify({'success': False, 'translated': text})

if __name__ == '__main__':
    app.run(debug=False, host='0.0.0.0', port=5000)

